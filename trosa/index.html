<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trosa Photo Share</title>
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <div id="status">Initialising...</div>

    <script>
        // 1. Register and listen for the new SW taking control
        navigator.serviceWorker.register('../sw.js', { scope: '../' });

        navigator.serviceWorker.addEventListener('controllerchange', () => {
            // Reloads the page automatically when the new SW activates
            window.location.reload();
        });

        async function getSecret() {
            let secret = localStorage.getItem('family-secret');
            if (!secret) {
                secret = prompt("Please enter the family secret:");
                if (secret) {
                    localStorage.setItem('family-secret', secret);
                }
            }
            return secret;
        }

        async function handleUpload() {
            const params = new URLSearchParams(window.location.search);
            if (!params.has('shared')) {
                document.getElementById('status').innerText = 'Ready to receive photos.';
                return;
            }

            const secret = await getSecret();
            if (!secret) {
                document.getElementById('status').innerText = 'Upload cancelled: Secret required.';
                return;
            }

            document.getElementById('status').innerText = 'Uploading...';

            try {
                const cache = await caches.open('shared-photos');
                const response = await cache.match('/shared-file');
                
                // FIX 1: If the file is gone, don't try to upload again
                if (!response) {
                    document.getElementById('status').innerText = 'Photo already processed.';
                    return;
                }
                
                const blob = await response.blob();
                const uploadResponse = await fetch('https://jbvlww2fwewgw5b455oaddxz6m0gkvjg.lambda-url.eu-west-1.on.aws/', {
                    method: 'POST',
                    body: blob,
                    headers: {
                        'x-family-secret': secret,
                        'x-folder-name': 'trosa',
                        'Content-Type': blob.type
                    }
                });

                if (uploadResponse.ok) {
                    document.getElementById('status').innerText = 'Success! Photo uploaded.';
                    
                    // FIX 2: Delete the file from cache so it can't be re-uploaded
                    await cache.delete('/shared-file');

                    // FIX 3: Remove "?shared=true" from the URL bar without reloading the page
                    const cleanUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);

                } else {
                    const errorText = await uploadResponse.text();
                    document.getElementById('status').innerText = `Upload failed (${uploadResponse.status}): ${errorText}`;
                }
            } catch (err) {
                document.getElementById('status').innerText = 'Error: ' + err.message;
            }
        }

        handleUpload();
    </script>
</body>
</html>